"use strict";var _a;Object.defineProperty(exports,"__esModule",{value:!0}),exports.HttpCodeTarget=exports.HttpCodeElb=exports.ApplicationLoadBalancer=void 0;const jsiiDeprecationWarnings=require("../../../.warnings.jsii.js"),JSII_RTTI_SYMBOL_1=Symbol.for("jsii.rtti"),cloudwatch=require("../../../aws-cloudwatch"),ec2=require("../../../aws-ec2"),cxschema=require("../../../cloud-assembly-schema"),core_1=require("../../../core"),cxapi=require("../../../cx-api"),elasticloadbalancingv2_canned_metrics_generated_1=require("../elasticloadbalancingv2-canned-metrics.generated"),base_load_balancer_1=require("../shared/base-load-balancer"),enums_1=require("../shared/enums"),application_listener_1=require("./application-listener"),application_listener_action_1=require("./application-listener-action");class ApplicationLoadBalancer extends base_load_balancer_1.BaseLoadBalancer{constructor(scope,id,props){var _b;super(scope,id,props,{type:"application",securityGroups:core_1.Lazy.list({produce:()=>this.connections.securityGroups.map(sg=>sg.securityGroupId)}),ipAddressType:props.ipAddressType});jsiiDeprecationWarnings.aws_cdk_lib_aws_elasticloadbalancingv2_ApplicationLoadBalancerProps(props),this.ipAddressType=(_b=props.ipAddressType)!==null&&_b!==void 0?_b:enums_1.IpAddressType.IPV4;const securityGroups=[props.securityGroup||new ec2.SecurityGroup(this,"SecurityGroup",{vpc:props.vpc,description:`Automatically created Security Group for ELB ${core_1.Names.uniqueId(this)}`,allowAllOutbound:!1})];this.connections=new ec2.Connections({securityGroups}),this.listeners=[],props.http2Enabled===!1&&this.setAttribute("routing.http2.enabled","false"),props.idleTimeout!==void 0&&this.setAttribute("idle_timeout.timeout_seconds",props.idleTimeout.toSeconds().toString())}static fromLookup(scope,id,options){jsiiDeprecationWarnings.aws_cdk_lib_aws_elasticloadbalancingv2_ApplicationLoadBalancerLookupOptions(options);const props=base_load_balancer_1.BaseLoadBalancer._queryContextProvider(scope,{userOptions:options,loadBalancerType:cxschema.LoadBalancerType.APPLICATION});return new LookedUpApplicationLoadBalancer(scope,id,props)}static fromApplicationLoadBalancerAttributes(scope,id,attrs){return jsiiDeprecationWarnings.aws_cdk_lib_aws_elasticloadbalancingv2_ApplicationLoadBalancerAttributes(attrs),new ImportedApplicationLoadBalancer(scope,id,attrs)}addListener(id,props){jsiiDeprecationWarnings.aws_cdk_lib_aws_elasticloadbalancingv2_BaseApplicationListenerProps(props);const listener=new application_listener_1.ApplicationListener(this,id,{loadBalancer:this,...props});return this.listeners.push(listener),listener}addRedirect(props={}){var _b,_c,_d,_e,_f;jsiiDeprecationWarnings.aws_cdk_lib_aws_elasticloadbalancingv2_ApplicationLoadBalancerRedirectConfig(props);const sourcePort=(_b=props.sourcePort)!==null&&_b!==void 0?_b:80,targetPort=((_c=props.targetPort)!==null&&_c!==void 0?_c:443).toString();return this.addListener(`Redirect${sourcePort}To${targetPort}`,{protocol:(_d=props.sourceProtocol)!==null&&_d!==void 0?_d:enums_1.ApplicationProtocol.HTTP,port:sourcePort,open:(_e=props.open)!==null&&_e!==void 0?_e:!0,defaultAction:application_listener_action_1.ListenerAction.redirect({port:targetPort,protocol:(_f=props.targetProtocol)!==null&&_f!==void 0?_f:enums_1.ApplicationProtocol.HTTPS,permanent:!0})})}addSecurityGroup(securityGroup){jsiiDeprecationWarnings.aws_cdk_lib_aws_ec2_ISecurityGroup(securityGroup),this.connections.addSecurityGroup(securityGroup)}metric(metricName,props){return jsiiDeprecationWarnings.aws_cdk_lib_aws_cloudwatch_MetricOptions(props),new cloudwatch.Metric({namespace:"AWS/ApplicationELB",metricName,dimensionsMap:{LoadBalancer:this.loadBalancerFullName},...props})}metricActiveConnectionCount(props){return jsiiDeprecationWarnings.aws_cdk_lib_aws_cloudwatch_MetricOptions(props),this.cannedMetric(elasticloadbalancingv2_canned_metrics_generated_1.ApplicationELBMetrics.activeConnectionCountSum,props)}metricClientTlsNegotiationErrorCount(props){return jsiiDeprecationWarnings.aws_cdk_lib_aws_cloudwatch_MetricOptions(props),this.cannedMetric(elasticloadbalancingv2_canned_metrics_generated_1.ApplicationELBMetrics.clientTlsNegotiationErrorCountSum,props)}metricConsumedLCUs(props){return jsiiDeprecationWarnings.aws_cdk_lib_aws_cloudwatch_MetricOptions(props),this.cannedMetric(elasticloadbalancingv2_canned_metrics_generated_1.ApplicationELBMetrics.consumedLcUsAverage,{statistic:"sum",...props})}metricHttpFixedResponseCount(props){return jsiiDeprecationWarnings.aws_cdk_lib_aws_cloudwatch_MetricOptions(props),this.cannedMetric(elasticloadbalancingv2_canned_metrics_generated_1.ApplicationELBMetrics.httpFixedResponseCountSum,props)}metricHttpRedirectCount(props){return jsiiDeprecationWarnings.aws_cdk_lib_aws_cloudwatch_MetricOptions(props),this.cannedMetric(elasticloadbalancingv2_canned_metrics_generated_1.ApplicationELBMetrics.httpRedirectCountSum,props)}metricHttpRedirectUrlLimitExceededCount(props){return jsiiDeprecationWarnings.aws_cdk_lib_aws_cloudwatch_MetricOptions(props),this.cannedMetric(elasticloadbalancingv2_canned_metrics_generated_1.ApplicationELBMetrics.httpRedirectUrlLimitExceededCountSum,props)}metricHttpCodeElb(code,props){return jsiiDeprecationWarnings.aws_cdk_lib_aws_elasticloadbalancingv2_HttpCodeElb(code),jsiiDeprecationWarnings.aws_cdk_lib_aws_cloudwatch_MetricOptions(props),this.metric(code,{statistic:"Sum",...props})}metricHttpCodeTarget(code,props){return jsiiDeprecationWarnings.aws_cdk_lib_aws_elasticloadbalancingv2_HttpCodeTarget(code),jsiiDeprecationWarnings.aws_cdk_lib_aws_cloudwatch_MetricOptions(props),this.metric(code,{statistic:"Sum",...props})}metricIpv6ProcessedBytes(props){return jsiiDeprecationWarnings.aws_cdk_lib_aws_cloudwatch_MetricOptions(props),this.cannedMetric(elasticloadbalancingv2_canned_metrics_generated_1.ApplicationELBMetrics.iPv6ProcessedBytesSum,props)}metricIpv6RequestCount(props){return jsiiDeprecationWarnings.aws_cdk_lib_aws_cloudwatch_MetricOptions(props),this.cannedMetric(elasticloadbalancingv2_canned_metrics_generated_1.ApplicationELBMetrics.iPv6RequestCountSum,props)}metricNewConnectionCount(props){return jsiiDeprecationWarnings.aws_cdk_lib_aws_cloudwatch_MetricOptions(props),this.cannedMetric(elasticloadbalancingv2_canned_metrics_generated_1.ApplicationELBMetrics.newConnectionCountSum,props)}metricProcessedBytes(props){return jsiiDeprecationWarnings.aws_cdk_lib_aws_cloudwatch_MetricOptions(props),this.cannedMetric(elasticloadbalancingv2_canned_metrics_generated_1.ApplicationELBMetrics.processedBytesSum,props)}metricRejectedConnectionCount(props){return jsiiDeprecationWarnings.aws_cdk_lib_aws_cloudwatch_MetricOptions(props),this.cannedMetric(elasticloadbalancingv2_canned_metrics_generated_1.ApplicationELBMetrics.rejectedConnectionCountSum,props)}metricRequestCount(props){return jsiiDeprecationWarnings.aws_cdk_lib_aws_cloudwatch_MetricOptions(props),this.cannedMetric(elasticloadbalancingv2_canned_metrics_generated_1.ApplicationELBMetrics.requestCountSum,props)}metricRuleEvaluations(props){return jsiiDeprecationWarnings.aws_cdk_lib_aws_cloudwatch_MetricOptions(props),this.cannedMetric(elasticloadbalancingv2_canned_metrics_generated_1.ApplicationELBMetrics.ruleEvaluationsSum,props)}metricTargetConnectionErrorCount(props){return jsiiDeprecationWarnings.aws_cdk_lib_aws_cloudwatch_MetricOptions(props),this.metric("TargetConnectionErrorCount",{statistic:"Sum",...props})}metricTargetResponseTime(props){return jsiiDeprecationWarnings.aws_cdk_lib_aws_cloudwatch_MetricOptions(props),this.metric("TargetResponseTime",{statistic:"Average",...props})}metricTargetTLSNegotiationErrorCount(props){return jsiiDeprecationWarnings.aws_cdk_lib_aws_cloudwatch_MetricOptions(props),this.metric("TargetTLSNegotiationErrorCount",{statistic:"Sum",...props})}metricElbAuthError(props){return jsiiDeprecationWarnings.aws_cdk_lib_aws_cloudwatch_MetricOptions(props),this.metric("ELBAuthError",{statistic:"Sum",...props})}metricElbAuthFailure(props){return jsiiDeprecationWarnings.aws_cdk_lib_aws_cloudwatch_MetricOptions(props),this.metric("ELBAuthFailure",{statistic:"Sum",...props})}metricElbAuthLatency(props){return jsiiDeprecationWarnings.aws_cdk_lib_aws_cloudwatch_MetricOptions(props),this.metric("ELBAuthLatency",{statistic:"Average",...props})}metricElbAuthSuccess(props){return jsiiDeprecationWarnings.aws_cdk_lib_aws_cloudwatch_MetricOptions(props),this.metric("ELBAuthSuccess",{statistic:"Sum",...props})}cannedMetric(fn,props){return new cloudwatch.Metric({...fn({LoadBalancer:this.loadBalancerFullName}),...props}).attachTo(this)}}exports.ApplicationLoadBalancer=ApplicationLoadBalancer,_a=JSII_RTTI_SYMBOL_1,ApplicationLoadBalancer[_a]={fqn:"aws-cdk-lib.aws_elasticloadbalancingv2.ApplicationLoadBalancer",version:"2.15.0"};var HttpCodeElb;(function(HttpCodeElb2){HttpCodeElb2.ELB_3XX_COUNT="HTTPCode_ELB_3XX_Count",HttpCodeElb2.ELB_4XX_COUNT="HTTPCode_ELB_4XX_Count",HttpCodeElb2.ELB_5XX_COUNT="HTTPCode_ELB_5XX_Count"})(HttpCodeElb=exports.HttpCodeElb||(exports.HttpCodeElb={}));var HttpCodeTarget;(function(HttpCodeTarget2){HttpCodeTarget2.TARGET_2XX_COUNT="HTTPCode_Target_2XX_Count",HttpCodeTarget2.TARGET_3XX_COUNT="HTTPCode_Target_3XX_Count",HttpCodeTarget2.TARGET_4XX_COUNT="HTTPCode_Target_4XX_Count",HttpCodeTarget2.TARGET_5XX_COUNT="HTTPCode_Target_5XX_Count"})(HttpCodeTarget=exports.HttpCodeTarget||(exports.HttpCodeTarget={}));class ImportedApplicationLoadBalancer extends core_1.Resource{constructor(scope,id,props){super(scope,id,{environmentFromArn:props.loadBalancerArn});this.props=props,this.vpc=props.vpc,this.loadBalancerArn=props.loadBalancerArn,this.connections=new ec2.Connections({securityGroups:[ec2.SecurityGroup.fromSecurityGroupId(this,"SecurityGroup",props.securityGroupId,{allowAllOutbound:props.securityGroupAllowsAllOutbound})]})}get listeners(){throw Error(".listeners can only be accessed if the class was constructed as an owned, not imported, load balancer")}addListener(id,props){return new application_listener_1.ApplicationListener(this,id,{loadBalancer:this,...props})}get loadBalancerCanonicalHostedZoneId(){if(this.props.loadBalancerCanonicalHostedZoneId)return this.props.loadBalancerCanonicalHostedZoneId;throw new Error(`'loadBalancerCanonicalHostedZoneId' was not provided when constructing Application Load Balancer ${this.node.path} from attributes`)}get loadBalancerDnsName(){if(this.props.loadBalancerDnsName)return this.props.loadBalancerDnsName;throw new Error(`'loadBalancerDnsName' was not provided when constructing Application Load Balancer ${this.node.path} from attributes`)}}class LookedUpApplicationLoadBalancer extends core_1.Resource{constructor(scope,id,props){super(scope,id,{environmentFromArn:props.loadBalancerArn});this.loadBalancerArn=props.loadBalancerArn,this.loadBalancerCanonicalHostedZoneId=props.loadBalancerCanonicalHostedZoneId,this.loadBalancerDnsName=props.loadBalancerDnsName,props.ipAddressType===cxapi.LoadBalancerIpAddressType.IPV4?this.ipAddressType=enums_1.IpAddressType.IPV4:props.ipAddressType===cxapi.LoadBalancerIpAddressType.DUAL_STACK&&(this.ipAddressType=enums_1.IpAddressType.DUAL_STACK),this.vpc=ec2.Vpc.fromLookup(this,"Vpc",{vpcId:props.vpcId}),this.connections=new ec2.Connections;for(const securityGroupId of props.securityGroupIds){const securityGroup=ec2.SecurityGroup.fromLookupById(this,`SecurityGroup-${securityGroupId}`,securityGroupId);this.connections.addSecurityGroup(securityGroup)}}get listeners(){throw Error(".listeners can only be accessed if the class was constructed as an owned, not looked up, load balancer")}addListener(id,props){return new application_listener_1.ApplicationListener(this,id,{...props,loadBalancer:this})}}
//# sourceMappingURL=application-load-balancer.js.map
