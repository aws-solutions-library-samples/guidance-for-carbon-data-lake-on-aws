{
  "version": 3,
  "sources": ["function.ts"],
  "sourcesContent": ["import * as fs from 'fs';\nimport * as path from 'path';\nimport * as lambda from '../../aws-lambda';\nimport { Architecture } from '../../aws-lambda';\nimport { Construct } from 'constructs';\nimport { Bundling } from './bundling';\nimport { LockFile } from './package-manager';\nimport { BundlingOptions } from './types';\nimport { callsites, findUpMultiple } from './util';\n\n/**\n * Properties for a NodejsFunction\n */\nexport interface NodejsFunctionProps extends lambda.FunctionOptions {\n  /**\n   * Path to the entry file (JavaScript or TypeScript).\n   *\n   * @default - Derived from the name of the defining file and the construct's id.\n   * If the `NodejsFunction` is defined in `stack.ts` with `my-handler` as id\n   * (`new NodejsFunction(this, 'my-handler')`), the construct will look at `stack.my-handler.ts`\n   * and `stack.my-handler.js`.\n   */\n  readonly entry?: string;\n\n  /**\n   * The name of the exported handler in the entry file.\n   *\n   * @default handler\n   */\n  readonly handler?: string;\n\n  /**\n   * The runtime environment. Only runtimes of the Node.js family are\n   * supported.\n   *\n   * @default Runtime.NODEJS_14_X\n   */\n  readonly runtime?: lambda.Runtime;\n\n  /**\n   * Whether to automatically reuse TCP connections when working with the AWS\n   * SDK for JavaScript.\n   *\n   * This sets the `AWS_NODEJS_CONNECTION_REUSE_ENABLED` environment variable\n   * to `1`.\n   *\n   * @see https://docs.aws.amazon.com/sdk-for-javascript/v2/developer-guide/node-reusing-connections.html\n   *\n   * @default true\n   */\n  readonly awsSdkConnectionReuse?: boolean;\n\n  /**\n   * The path to the dependencies lock file (`yarn.lock` or `package-lock.json`).\n   *\n   * This will be used as the source for the volume mounted in the Docker\n   * container.\n   *\n   * Modules specified in `nodeModules` will be installed using the right\n   * installer (`npm` or `yarn`) along with this lock file.\n   *\n   * @default - the path is found by walking up parent directories searching for\n   *   a `yarn.lock` or `package-lock.json` file\n   */\n  readonly depsLockFilePath?: string;\n\n  /**\n   * Bundling options\n   *\n   * @default - use default bundling options: no minify, no sourcemap, all\n   *   modules are bundled.\n   */\n  readonly bundling?: BundlingOptions;\n\n  /**\n   * The path to the directory containing project config files (`package.json` or `tsconfig.json`)\n   *\n   * @default - the directory containing the `depsLockFilePath`\n   */\n  readonly projectRoot?: string;\n}\n\n/**\n * A Node.js Lambda function bundled using esbuild\n */\nexport class NodejsFunction extends lambda.Function {\n  constructor(scope: Construct, id: string, props: NodejsFunctionProps = {}) {\n    if (props.runtime && props.runtime.family !== lambda.RuntimeFamily.NODEJS) {\n      throw new Error('Only `NODEJS` runtimes are supported.');\n    }\n\n    // Entry and defaults\n    const entry = path.resolve(findEntry(id, props.entry));\n    const handler = props.handler ?? 'handler';\n    const runtime = props.runtime ?? lambda.Runtime.NODEJS_14_X;\n    const architecture = props.architecture ?? Architecture.X86_64;\n    const depsLockFilePath = findLockFile(props.depsLockFilePath);\n    const projectRoot = props.projectRoot ?? path.dirname(depsLockFilePath);\n\n    super(scope, id, {\n      ...props,\n      runtime,\n      code: Bundling.bundle({\n        ...props.bundling ?? {},\n        entry,\n        runtime,\n        architecture,\n        depsLockFilePath,\n        projectRoot,\n      }),\n      handler: `index.${handler}`,\n    });\n\n    // Enable connection reuse for aws-sdk\n    if (props.awsSdkConnectionReuse ?? true) {\n      this.addEnvironment('AWS_NODEJS_CONNECTION_REUSE_ENABLED', '1', { removeInEdge: true });\n    }\n  }\n}\n\n/**\n * Checks given lock file or searches for a lock file\n */\nfunction findLockFile(depsLockFilePath?: string): string {\n  if (depsLockFilePath) {\n    if (!fs.existsSync(depsLockFilePath)) {\n      throw new Error(`Lock file at ${depsLockFilePath} doesn't exist`);\n    }\n\n    if (!fs.statSync(depsLockFilePath).isFile()) {\n      throw new Error('`depsLockFilePath` should point to a file');\n    }\n\n    return path.resolve(depsLockFilePath);\n  }\n\n  const lockFiles = findUpMultiple([\n    LockFile.PNPM,\n    LockFile.YARN,\n    LockFile.NPM,\n  ]);\n\n  if (lockFiles.length === 0) {\n    throw new Error('Cannot find a package lock file (`pnpm-lock.yaml`, `yarn.lock` or `package-lock.json`). Please specify it with `depsFileLockPath`.');\n  }\n  if (lockFiles.length > 1) {\n    throw new Error(`Multiple package lock files found: ${lockFiles.join(', ')}. Please specify the desired one with \\`depsFileLockPath\\`.`);\n  }\n\n  return lockFiles[0];\n}\n\n/**\n * Searches for an entry file. Preference order is the following:\n * 1. Given entry file\n * 2. A .ts file named as the defining file with id as suffix (defining-file.id.ts)\n * 3. A .js file name as the defining file with id as suffix (defining-file.id.js)\n * 4. A .mjs file name as the defining file with id as suffix (defining-file.id.mjs)\n */\nfunction findEntry(id: string, entry?: string): string {\n  if (entry) {\n    if (!/\\.(jsx?|tsx?|mjs)$/.test(entry)) {\n      throw new Error('Only JavaScript or TypeScript entry files are supported.');\n    }\n    if (!fs.existsSync(entry)) {\n      throw new Error(`Cannot find entry file at ${entry}`);\n    }\n    return entry;\n  }\n\n  const definingFile = findDefiningFile();\n  const extname = path.extname(definingFile);\n\n  const tsHandlerFile = definingFile.replace(new RegExp(`${extname}$`), `.${id}.ts`);\n  if (fs.existsSync(tsHandlerFile)) {\n    return tsHandlerFile;\n  }\n\n  const jsHandlerFile = definingFile.replace(new RegExp(`${extname}$`), `.${id}.js`);\n  if (fs.existsSync(jsHandlerFile)) {\n    return jsHandlerFile;\n  }\n\n  const mjsHandlerFile = definingFile.replace(new RegExp(`${extname}$`), `.${id}.mjs`);\n  if (fs.existsSync(mjsHandlerFile)) {\n    return mjsHandlerFile;\n  }\n\n  throw new Error(`Cannot find handler file ${tsHandlerFile}, ${jsHandlerFile} or ${mjsHandlerFile}`);\n}\n\n/**\n * Finds the name of the file where the `NodejsFunction` is defined\n */\nfunction findDefiningFile(): string {\n  let definingIndex;\n  const sites = callsites();\n  for (const [index, site] of sites.entries()) {\n    if (site.getFunctionName() === 'NodejsFunction') {\n      // The next site is the site where the NodejsFunction was created\n      definingIndex = index + 1;\n      break;\n    }\n  }\n\n  if (!definingIndex || !sites[definingIndex]) {\n    throw new Error('Cannot find defining file.');\n  }\n\n  return sites[definingIndex].getFileName();\n}\n"],
  "mappings": "qNAAA,GAAA,QAAA,MACA,KAAA,QAAA,QACA,OAAA,QAAA,oBACA,aAAA,QAAA,oBAEA,WAAA,QAAA,cACA,kBAAA,QAAA,qBAEA,OAAA,QAAA,UA6EA,4BAAoC,QAAO,QAAQ,CACjD,YAAY,MAAkB,GAAY,MAA6B,GAAE,uBACvE,oFAAI,MAAM,SAAW,MAAM,QAAQ,SAAW,OAAO,cAAc,OACjE,KAAM,IAAI,OAAM,yCAIlB,KAAM,OAAQ,KAAK,QAAQ,UAAU,GAAI,MAAM,QACzC,QAAO,IAAG,MAAM,WAAO,MAAA,KAAA,OAAA,GAAI,UAC3B,QAAO,IAAG,MAAM,WAAO,MAAA,KAAA,OAAA,GAAI,OAAO,QAAQ,YAC1C,aAAY,IAAG,MAAM,gBAAY,MAAA,KAAA,OAAA,GAAI,aAAA,aAAa,OAClD,iBAAmB,aAAa,MAAM,kBACtC,YAAW,IAAG,MAAM,eAAW,MAAA,KAAA,OAAA,GAAI,KAAK,QAAQ,kBAEtD,MAAM,MAAO,GAAI,IACZ,MACH,QACA,KAAM,WAAA,SAAS,OAAO,IACpB,IAAG,MAAM,YAAQ,MAAA,KAAA,OAAA,GAAI,GACrB,MACA,QACA,aACA,iBACA,cAEF,QAAS,SAAS,YAIpB,AAAA,KAAI,MAAM,yBAAqB,MAAA,KAAA,OAAA,GAAI,KACjC,KAAK,eAAe,sCAAuC,IAAK,CAAE,aAAc,MA9BtF,QAAA,eAAA,8HAsCA,sBAAsB,iBAAyB,CAC7C,GAAI,iBAAkB,CACpB,GAAI,CAAC,GAAG,WAAW,kBACjB,KAAM,IAAI,OAAM,gBAAgB,kCAGlC,GAAI,CAAC,GAAG,SAAS,kBAAkB,SACjC,KAAM,IAAI,OAAM,6CAGlB,MAAO,MAAK,QAAQ,kBAGtB,KAAM,WAAY,OAAA,eAAe,CAC/B,kBAAA,SAAS,KACT,kBAAA,SAAS,KACT,kBAAA,SAAS,MAGX,GAAI,UAAU,SAAW,EACvB,KAAM,IAAI,OAAM,sIAElB,GAAI,UAAU,OAAS,EACrB,KAAM,IAAI,OAAM,sCAAsC,UAAU,KAAK,oEAGvE,MAAO,WAAU,GAUnB,mBAAmB,GAAY,MAAc,CAC3C,GAAI,MAAO,CACT,GAAI,CAAC,qBAAqB,KAAK,OAC7B,KAAM,IAAI,OAAM,4DAElB,GAAI,CAAC,GAAG,WAAW,OACjB,KAAM,IAAI,OAAM,6BAA6B,SAE/C,MAAO,OAGT,KAAM,cAAe,mBACf,QAAU,KAAK,QAAQ,cAEvB,cAAgB,aAAa,QAAQ,GAAI,QAAO,GAAG,YAAa,IAAI,SAC1E,GAAI,GAAG,WAAW,eAChB,MAAO,eAGT,KAAM,eAAgB,aAAa,QAAQ,GAAI,QAAO,GAAG,YAAa,IAAI,SAC1E,GAAI,GAAG,WAAW,eAChB,MAAO,eAGT,KAAM,gBAAiB,aAAa,QAAQ,GAAI,QAAO,GAAG,YAAa,IAAI,UAC3E,GAAI,GAAG,WAAW,gBAChB,MAAO,gBAGT,KAAM,IAAI,OAAM,4BAA4B,kBAAkB,oBAAoB,kBAMpF,2BAAyB,CACvB,GAAI,eACJ,KAAM,OAAQ,OAAA,YACd,SAAW,CAAC,MAAO,OAAS,OAAM,UAChC,GAAI,KAAK,oBAAsB,iBAAkB,CAE/C,cAAgB,MAAQ,EACxB,MAIJ,GAAI,CAAC,eAAiB,CAAC,MAAM,eAC3B,KAAM,IAAI,OAAM,8BAGlB,MAAO,OAAM,eAAe",
  "names": []
}
