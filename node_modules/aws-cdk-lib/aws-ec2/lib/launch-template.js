"use strict";var _a,_b;Object.defineProperty(exports,"__esModule",{value:!0}),exports.LaunchTemplate=exports.LaunchTemplateSpecialVersions=exports.SpotRequestType=exports.SpotInstanceInterruption=exports.InstanceInitiatedShutdownBehavior=exports.CpuCredits=void 0;const jsiiDeprecationWarnings=require("../../.warnings.jsii.js"),JSII_RTTI_SYMBOL_1=Symbol.for("jsii.rtti"),iam=require("../../aws-iam"),core_1=require("../../core"),_1=require("."),connections_1=require("./connections"),ec2_generated_1=require("./ec2.generated"),ebs_util_1=require("./private/ebs-util"),NAME_TAG="Name";var CpuCredits;(function(CpuCredits2){CpuCredits2.STANDARD="standard",CpuCredits2.UNLIMITED="unlimited"})(CpuCredits=exports.CpuCredits||(exports.CpuCredits={}));var InstanceInitiatedShutdownBehavior;(function(InstanceInitiatedShutdownBehavior2){InstanceInitiatedShutdownBehavior2.STOP="stop",InstanceInitiatedShutdownBehavior2.TERMINATE="terminate"})(InstanceInitiatedShutdownBehavior=exports.InstanceInitiatedShutdownBehavior||(exports.InstanceInitiatedShutdownBehavior={}));var SpotInstanceInterruption;(function(SpotInstanceInterruption2){SpotInstanceInterruption2.STOP="stop",SpotInstanceInterruption2.TERMINATE="terminate",SpotInstanceInterruption2.HIBERNATE="hibernate"})(SpotInstanceInterruption=exports.SpotInstanceInterruption||(exports.SpotInstanceInterruption={}));var SpotRequestType;(function(SpotRequestType2){SpotRequestType2.ONE_TIME="one-time",SpotRequestType2.PERSISTENT="persistent"})(SpotRequestType=exports.SpotRequestType||(exports.SpotRequestType={}));class LaunchTemplateSpecialVersions{}exports.LaunchTemplateSpecialVersions=LaunchTemplateSpecialVersions,_a=JSII_RTTI_SYMBOL_1,LaunchTemplateSpecialVersions[_a]={fqn:"aws-cdk-lib.aws_ec2.LaunchTemplateSpecialVersions",version:"2.15.0"},LaunchTemplateSpecialVersions.LATEST_VERSION="$Latest",LaunchTemplateSpecialVersions.DEFAULT_VERSION="$Default";class LaunchTemplate extends core_1.Resource{constructor(scope,id,props={}){var _c,_d,_e,_f,_g,_h;super(scope,id);jsiiDeprecationWarnings.aws_cdk_lib_aws_ec2_LaunchTemplateProps(props);const spotDuration=(_d=(_c=props==null?void 0:props.spotOptions)===null||_c===void 0?void 0:_c.blockDuration)===null||_d===void 0?void 0:_d.toHours({integral:!0});spotDuration!==void 0&&(spotDuration<1||spotDuration>6)&&core_1.Annotations.of(this).addError("Spot block duration must be exactly 1, 2, 3, 4, 5, or 6 hours."),this.role=props.role,this._grantPrincipal=this.role;const iamProfile=this.role?new iam.CfnInstanceProfile(this,"Profile",{roles:[this.role.roleName]}):void 0;props.securityGroup&&(this._connections=new connections_1.Connections({securityGroups:[props.securityGroup]}));const securityGroupsToken=core_1.Lazy.list({produce:()=>{if(this._connections&&this._connections.securityGroups.length>0)return this._connections.securityGroups.map(sg=>sg.securityGroupId)}});props.userData&&(this.userData=props.userData);const userDataToken=core_1.Lazy.string({produce:()=>{if(this.userData)return core_1.Fn.base64(this.userData.render())}}),imageConfig=(_e=props.machineImage)===null||_e===void 0?void 0:_e.getImage(this);imageConfig&&(this.osType=imageConfig.osType);let marketOptions;(props==null?void 0:props.spotOptions)&&(marketOptions={marketType:"spot",spotOptions:{blockDurationMinutes:spotDuration!==void 0?spotDuration*60:void 0,instanceInterruptionBehavior:props.spotOptions.interruptionBehavior,maxPrice:(_f=props.spotOptions.maxPrice)===null||_f===void 0?void 0:_f.toString(),spotInstanceType:props.spotOptions.requestType,validUntil:(_g=props.spotOptions.validUntil)===null||_g===void 0?void 0:_g.date.toUTCString()}},Object.keys(marketOptions.spotOptions).filter(k=>marketOptions.spotOptions[k]).length==0&&(marketOptions.spotOptions=void 0)),this.tags=new core_1.TagManager(core_1.TagType.KEY_VALUE,"AWS::EC2::LaunchTemplate");const tagsToken=core_1.Lazy.any({produce:()=>{if(this.tags.hasTags()){const lowerCaseRenderedTags=this.tags.renderTags().map(tag=>({key:tag.Key,value:tag.Value}));return[{resourceType:"instance",tags:lowerCaseRenderedTags},{resourceType:"volume",tags:lowerCaseRenderedTags}]}}}),resource=new ec2_generated_1.CfnLaunchTemplate(this,"Resource",{launchTemplateName:props==null?void 0:props.launchTemplateName,launchTemplateData:{blockDeviceMappings:(props==null?void 0:props.blockDevices)!==void 0?ebs_util_1.launchTemplateBlockDeviceMappings(this,props.blockDevices):void 0,creditSpecification:(props==null?void 0:props.cpuCredits)!==void 0?{cpuCredits:props.cpuCredits}:void 0,disableApiTermination:props==null?void 0:props.disableApiTermination,ebsOptimized:props==null?void 0:props.ebsOptimized,enclaveOptions:(props==null?void 0:props.nitroEnclaveEnabled)!==void 0?{enabled:props.nitroEnclaveEnabled}:void 0,hibernationOptions:(props==null?void 0:props.hibernationConfigured)!==void 0?{configured:props.hibernationConfigured}:void 0,iamInstanceProfile:iamProfile!==void 0?{arn:iamProfile.getAtt("Arn").toString()}:void 0,imageId:imageConfig==null?void 0:imageConfig.imageId,instanceType:(_h=props==null?void 0:props.instanceType)===null||_h===void 0?void 0:_h.toString(),instanceInitiatedShutdownBehavior:props==null?void 0:props.instanceInitiatedShutdownBehavior,instanceMarketOptions:marketOptions,keyName:props==null?void 0:props.keyName,monitoring:(props==null?void 0:props.detailedMonitoring)!==void 0?{enabled:props.detailedMonitoring}:void 0,securityGroupIds:securityGroupsToken,tagSpecifications:tagsToken,userData:userDataToken}});core_1.Tags.of(this).add(NAME_TAG,this.node.path),this.defaultVersionNumber=resource.attrDefaultVersionNumber,this.latestVersionNumber=resource.attrLatestVersionNumber,this.launchTemplateId=resource.ref,this.versionNumber=core_1.Token.asString(resource.getAtt("LatestVersionNumber")),props.requireImdsv2&&core_1.Aspects.of(this).add(new _1.LaunchTemplateRequireImdsv2Aspect)}static fromLaunchTemplateAttributes(scope,id,attrs){jsiiDeprecationWarnings.aws_cdk_lib_aws_ec2_LaunchTemplateAttributes(attrs);const haveId=Boolean(attrs.launchTemplateId),haveName=Boolean(attrs.launchTemplateName);if(haveId==haveName)throw new Error("LaunchTemplate.fromLaunchTemplateAttributes() requires exactly one of launchTemplateId or launchTemplateName be provided.");class Import extends core_1.Resource{constructor(){var _c;super(...arguments);this.versionNumber=(_c=attrs.versionNumber)!==null&&_c!==void 0?_c:LaunchTemplateSpecialVersions.DEFAULT_VERSION,this.launchTemplateId=attrs.launchTemplateId,this.launchTemplateName=attrs.launchTemplateName}}return new Import(scope,id)}get connections(){if(!this._connections)throw new Error("LaunchTemplate can only be used as IConnectable if a securityGroup is provided when constructing it.");return this._connections}get grantPrincipal(){if(!this._grantPrincipal)throw new Error("LaunchTemplate can only be used as IGrantable if a role is provided when constructing it.");return this._grantPrincipal}}exports.LaunchTemplate=LaunchTemplate,_b=JSII_RTTI_SYMBOL_1,LaunchTemplate[_b]={fqn:"aws-cdk-lib.aws_ec2.LaunchTemplate",version:"2.15.0"};
//# sourceMappingURL=launch-template.js.map
