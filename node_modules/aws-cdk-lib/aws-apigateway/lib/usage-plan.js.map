{
  "version": 3,
  "sources": ["usage-plan.ts"],
  "sourcesContent": ["import { FeatureFlags, IResource, Lazy, Names, Resource, Token } from '../../core';\nimport { APIGATEWAY_USAGEPLANKEY_ORDERINSENSITIVE_ID } from '../../cx-api';\nimport { Construct } from 'constructs';\nimport { IApiKey } from './api-key';\nimport { CfnUsagePlan, CfnUsagePlanKey } from './apigateway.generated';\nimport { Method } from './method';\nimport { IRestApi } from './restapi';\nimport { Stage } from './stage';\nimport { validateDouble, validateInteger } from './util';\n\n/**\n * Container for defining throttling parameters to API stages or methods.\n * @link https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-request-throttling.html\n */\nexport interface ThrottleSettings {\n  /**\n   * The API request steady-state rate limit (average requests per second over an extended period of time)\n   * @default none\n   */\n  readonly rateLimit?: number;\n\n  /**\n   * The maximum API request rate limit over a time ranging from one to a few seconds.\n   * @default none\n   */\n  readonly burstLimit?: number;\n}\n\n/**\n * Time period for which quota settings apply.\n */\nexport enum Period {\n  DAY = 'DAY',\n  WEEK = 'WEEK',\n  MONTH = 'MONTH'\n}\n\n/**\n * Specifies the maximum number of requests that clients can make to API Gateway APIs.\n */\nexport interface QuotaSettings {\n  /**\n   * The maximum number of requests that users can make within the specified time period.\n   * @default none\n   */\n  readonly limit?: number;\n\n  /**\n   * For the initial time period, the number of requests to subtract from the specified limit.\n   * @default none\n   */\n  readonly offset?: number;\n\n  /**\n   * The time period for which the maximum limit of requests applies.\n   * @default none\n   */\n  readonly period?: Period;\n}\n\n/**\n * Represents per-method throttling for a resource.\n */\nexport interface ThrottlingPerMethod {\n  /**\n   * [disable-awslint:ref-via-interface]\n   * The method for which you specify the throttling settings.\n   * @default none\n   */\n  readonly method: Method;\n\n  /**\n   * Specifies the overall request rate (average requests per second) and burst capacity.\n   * @default none\n   */\n  readonly throttle: ThrottleSettings;\n}\n\n/**\n * Type of Usage Plan Key. Currently the only supported type is 'ApiKey'\n */\nconst enum UsagePlanKeyType {\n  API_KEY = 'API_KEY'\n}\n\n/**\n * Represents the API stages that a usage plan applies to.\n */\nexport interface UsagePlanPerApiStage {\n\n  /**\n   * @default none\n   */\n  readonly api?: IRestApi;\n\n  /**\n   *\n   * [disable-awslint:ref-via-interface]\n   * @default none\n   */\n  readonly stage?: Stage;\n\n  /**\n   * @default none\n   */\n  readonly throttle?: ThrottlingPerMethod[];\n}\n\nexport interface UsagePlanProps {\n  /**\n   * API Stages to be associated with the usage plan.\n   * @default none\n   */\n  readonly apiStages?: UsagePlanPerApiStage[];\n\n  /**\n   * Represents usage plan purpose.\n   * @default none\n   */\n  readonly description?: string;\n\n  /**\n   * Number of requests clients can make in a given time period.\n   * @default none\n   */\n  readonly quota?: QuotaSettings;\n\n  /**\n   * Overall throttle settings for the API.\n   * @default none\n   */\n  readonly throttle?: ThrottleSettings;\n\n  /**\n   * Name for this usage plan.\n   * @default none\n   */\n  readonly name?: string;\n\n  /**\n   * ApiKey to be associated with the usage plan.\n   * @default none\n   * @deprecated use `addApiKey()`\n   */\n  readonly apiKey?: IApiKey;\n}\n\n/**\n * Options to the UsagePlan.addApiKey() method\n */\nexport interface AddApiKeyOptions {\n  /**\n   * Override the CloudFormation logical id of the AWS::ApiGateway::UsagePlanKey resource\n   * @default - autogenerated by the CDK\n   */\n  readonly overrideLogicalId?: string;\n}\n\n/**\n * A UsagePlan, either managed by this CDK app, or imported.\n */\nexport interface IUsagePlan extends IResource {\n  /**\n   * Id of the usage plan\n   * @attribute\n   */\n  readonly usagePlanId: string;\n\n  /**\n   * Adds an ApiKey.\n   *\n   * @param apiKey the api key to associate with this usage plan\n   * @param options options that control the behaviour of this method\n   */\n  addApiKey(apiKey: IApiKey, options?: AddApiKeyOptions): void;\n\n}\n\nabstract class UsagePlanBase extends Resource implements IUsagePlan {\n  /**\n   * Id of the usage plan\n   * @attribute\n   */\n  public abstract readonly usagePlanId: string;\n\n  /**\n   * Adds an ApiKey.\n   *\n   * @param apiKey the api key to associate with this usage plan\n   * @param options options that control the behaviour of this method\n   */\n  public addApiKey(apiKey: IApiKey, options?: AddApiKeyOptions): void {\n    let id: string;\n    const prefix = 'UsagePlanKeyResource';\n\n    if (FeatureFlags.of(this).isEnabled(APIGATEWAY_USAGEPLANKEY_ORDERINSENSITIVE_ID)) {\n      id = `${prefix}:${Names.nodeUniqueId(apiKey.node)}`;\n    } else {\n      // Postfixing apikey id only from the 2nd child, to keep physicalIds of UsagePlanKey for existing CDK apps unmodified.\n      id = this.node.tryFindChild(prefix) ? `${prefix}:${Names.nodeUniqueId(apiKey.node)}` : prefix;\n    }\n\n    const resource = new CfnUsagePlanKey(this, id, {\n      keyId: apiKey.keyId,\n      keyType: UsagePlanKeyType.API_KEY,\n      usagePlanId: this.usagePlanId,\n    });\n    if (options?.overrideLogicalId) {\n      resource.overrideLogicalId(options?.overrideLogicalId);\n    }\n  }\n\n}\n\nexport class UsagePlan extends UsagePlanBase {\n\n  /**\n   * Import an externally defined usage plan using its ARN.\n   *\n   * @param scope  the construct that will \"own\" the imported usage plan.\n   * @param id     the id of the imported usage plan in the construct tree.\n   * @param usagePlanId the id of an existing usage plan.\n   */\n  public static fromUsagePlanId(scope: Construct, id: string, usagePlanId: string): IUsagePlan {\n    class Import extends UsagePlanBase {\n      public readonly usagePlanId = usagePlanId;\n\n      constructor() {\n        super(scope, id);\n      }\n    }\n    return new Import();\n  }\n\n  /**\n   * @attribute\n   */\n  public readonly usagePlanId: string;\n\n  private readonly apiStages = new Array<UsagePlanPerApiStage>();\n\n  constructor(scope: Construct, id: string, props: UsagePlanProps = { }) {\n    super(scope, id);\n    let resource: CfnUsagePlan;\n\n    resource = new CfnUsagePlan(this, 'Resource', {\n      apiStages: Lazy.any({ produce: () => this.renderApiStages(this.apiStages) }),\n      description: props.description,\n      quota: this.renderQuota(props),\n      throttle: this.renderThrottle(props.throttle),\n      usagePlanName: props.name,\n    });\n\n    this.apiStages.push(...(props.apiStages || []));\n\n    this.usagePlanId = resource.ref;\n\n    // Add ApiKey when\n    if (props.apiKey) {\n      this.addApiKey(props.apiKey);\n    }\n  }\n\n  /**\n   * Adds an apiStage.\n   * @param apiStage\n   */\n  public addApiStage(apiStage: UsagePlanPerApiStage) {\n    this.apiStages.push(apiStage);\n  }\n\n  /**\n   *\n   * @param props\n   */\n  private renderApiStages(apiStages: UsagePlanPerApiStage[] | undefined): CfnUsagePlan.ApiStageProperty[] | undefined {\n    if (apiStages && apiStages.length > 0) {\n      const stages: CfnUsagePlan.ApiStageProperty[] = [];\n      apiStages.forEach((apiStage: UsagePlanPerApiStage) => {\n        stages.push(this.createStage(apiStage));\n      });\n      return stages;\n    }\n    return undefined;\n  }\n\n  private createStage(apiStage: UsagePlanPerApiStage): CfnUsagePlan.ApiStageProperty {\n    const stage = apiStage.stage ? apiStage.stage.stageName.toString() : undefined;\n    const apiId = apiStage.stage ? apiStage.stage.restApi.restApiId : undefined;\n    const throttle = this.renderThrottlePerMethod(apiStage.throttle);\n    return {\n      apiId,\n      stage,\n      throttle,\n    };\n  }\n\n  private renderQuota(props: UsagePlanProps) {\n    if (props.quota === undefined) {\n      return undefined;\n    } else {\n      const limit = props.quota ? props.quota.limit : undefined;\n      validateInteger(limit, 'Throttle quota limit');\n      const ret = {\n        limit: limit ? limit : undefined,\n        offset: props.quota ? props.quota.offset : undefined,\n        period: props.quota ? props.quota.period : undefined,\n      };\n      return ret;\n    }\n  }\n\n  private renderThrottle(props: ThrottleSettings | undefined): (CfnUsagePlan.ThrottleSettingsProperty | Token) {\n    let ret: CfnUsagePlan.ThrottleSettingsProperty | Token;\n    if (props !== undefined) {\n      const burstLimit = props.burstLimit;\n      validateInteger(burstLimit, 'Throttle burst limit');\n      const rateLimit = props.rateLimit;\n      validateDouble(rateLimit, 'Throttle rate limit');\n\n      ret = {\n        burstLimit: burstLimit,\n        rateLimit: rateLimit,\n      };\n    }\n    return ret!;\n  }\n\n  private renderThrottlePerMethod(throttlePerMethod?: ThrottlingPerMethod[]) {\n    const ret: { [key: string]: (CfnUsagePlan.ThrottleSettingsProperty | Token) } = {};\n    if (throttlePerMethod && throttlePerMethod.length > 0) {\n      throttlePerMethod.forEach((value: ThrottlingPerMethod) => {\n        const method: Method = value.method;\n        // this methodId is resource path and method for example /GET or /pets/GET\n        const methodId = `${method.resource.path}/${method.httpMethod}`;\n        ret[methodId] = this.renderThrottle(value.throttle);\n      });\n    }\n    return ret;\n  }\n}\n"],
  "mappings": "+NAAA,OAAA,QAAA,cACA,SAAA,QAAA,gBAGA,uBAAA,QAAA,0BAIA,OAAA,QAAA,UAuBA,GAAY,QAAZ,AAAA,UAAY,QAAM,CAChB,QAAA,IAAA,MACA,QAAA,KAAA,OACA,QAAA,MAAA,UAHU,OAAA,QAAA,QAAA,SAAA,OAAM,KAmJlB,2BAAqC,QAAA,QAAQ,CAapC,UAAU,OAAiB,QAA0B,CAC1D,GAAI,IACJ,KAAM,QAAS,uBAEf,AAAI,OAAA,aAAa,GAAG,MAAM,UAAU,SAAA,6CAClC,GAAK,GAAG,UAAU,OAAA,MAAM,aAAa,OAAO,QAG5C,GAAK,KAAK,KAAK,aAAa,QAAU,GAAG,UAAU,OAAA,MAAM,aAAa,OAAO,QAAU,OAGzF,KAAM,UAAW,GAAI,wBAAA,gBAAgB,KAAM,GAAI,CAC7C,MAAO,OAAO,MACd,QAAO,UACP,YAAa,KAAK,cAEpB,AAAI,UAAO,KAAA,OAAP,QAAS,oBACX,SAAS,kBAAkB,SAAO,KAAA,OAAP,QAAS,oBAM1C,uBAA+B,cAAa,CA2B1C,YAAY,MAAkB,GAAY,MAAwB,GAAG,CACnE,MAAM,MAAO,IAHE,KAAA,UAAY,GAAI,gFAI/B,GAAI,UAEJ,SAAW,GAAI,wBAAA,aAAa,KAAM,WAAY,CAC5C,UAAW,OAAA,KAAK,IAAI,CAAE,QAAS,IAAM,KAAK,gBAAgB,KAAK,aAC/D,YAAa,MAAM,YACnB,MAAO,KAAK,YAAY,OACxB,SAAU,KAAK,eAAe,MAAM,UACpC,cAAe,MAAM,OAGvB,KAAK,UAAU,KAAK,GAAI,MAAM,WAAa,IAE3C,KAAK,YAAc,SAAS,IAGxB,MAAM,QACR,KAAK,UAAU,MAAM,cApCX,iBAAgB,MAAkB,GAAY,YAAmB,CAC7E,oBAAqB,cAAa,CAGhC,aAAA,CACE,MAAM,MAAO,IAHC,KAAA,YAAc,aAMhC,MAAO,IAAI,QAoCN,YAAY,SAA8B,mFAC/C,KAAK,UAAU,KAAK,UAOd,gBAAgB,UAA6C,CACnE,GAAI,WAAa,UAAU,OAAS,EAAG,CACrC,KAAM,QAA0C,GAChD,iBAAU,QAAQ,AAAC,UAAkC,CACnD,OAAO,KAAK,KAAK,YAAY,aAExB,QAKH,YAAY,SAA8B,CAChD,KAAM,OAAQ,SAAS,MAAQ,SAAS,MAAM,UAAU,WAAa,OAC/D,MAAQ,SAAS,MAAQ,SAAS,MAAM,QAAQ,UAAY,OAC5D,SAAW,KAAK,wBAAwB,SAAS,UACvD,MAAO,CACL,MACA,MACA,UAII,YAAY,MAAqB,CACvC,GAAI,MAAM,QAAU,OAEb,CACL,KAAM,OAAQ,MAAM,MAAQ,MAAM,MAAM,MAAQ,OAChD,cAAA,gBAAgB,MAAO,wBACX,CACV,MAAO,OAAgB,OACvB,OAAQ,MAAM,MAAQ,MAAM,MAAM,OAAS,OAC3C,OAAQ,MAAM,MAAQ,MAAM,MAAM,OAAS,SAMzC,eAAe,MAAmC,CACxD,GAAI,KACJ,GAAI,QAAU,OAAW,CACvB,KAAM,YAAa,MAAM,WACzB,OAAA,gBAAgB,WAAY,wBAC5B,KAAM,WAAY,MAAM,UACxB,OAAA,eAAe,UAAW,uBAE1B,IAAM,CACJ,WACA,WAGJ,MAAO,KAGD,wBAAwB,kBAAyC,CACvE,KAAM,KAA0E,GAChF,MAAI,oBAAqB,kBAAkB,OAAS,GAClD,kBAAkB,QAAQ,AAAC,OAA8B,CACvD,KAAM,QAAiB,MAAM,OAEvB,SAAW,GAAG,OAAO,SAAS,QAAQ,OAAO,aACnD,IAAI,UAAY,KAAK,eAAe,MAAM,YAGvC,KA5HX,QAAA,UAAA",
  "names": []
}
