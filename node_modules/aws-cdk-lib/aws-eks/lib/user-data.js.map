{
  "version": 3,
  "sources": ["user-data.ts"],
  "sourcesContent": ["import * as autoscaling from '../../aws-autoscaling';\nimport { Stack } from '../../core';\nimport { BootstrapOptions, ICluster } from './cluster';\n\n// eslint-disable-next-line max-len\nexport function renderAmazonLinuxUserData(cluster: ICluster, autoScalingGroup: autoscaling.AutoScalingGroup, options: BootstrapOptions = {}): string[] {\n\n  const stack = Stack.of(autoScalingGroup);\n\n  // determine logical id of ASG so we can signal cloudformation\n  const cfn = autoScalingGroup.node.defaultChild as autoscaling.CfnAutoScalingGroup;\n  const asgLogicalId = cfn.logicalId;\n\n  const extraArgs = new Array<string>();\n\n  try {\n    const clusterEndpoint = cluster.clusterEndpoint;\n    const clusterCertificateAuthorityData =\n      cluster.clusterCertificateAuthorityData;\n    extraArgs.push(`--apiserver-endpoint '${clusterEndpoint}'`);\n    extraArgs.push(`--b64-cluster-ca '${clusterCertificateAuthorityData}'`);\n  } catch (e) {\n    /**\n     * Errors are ignored here.\n     * apiserver-endpoint and b64-cluster-ca arguments are added in #12659 to make nodes join the cluster faster.\n     * As these are not necessary arguments, we don't need to pass these arguments when they don't exist.\n     *\n     * @see https://github.com/aws/aws-cdk/pull/12659\n     */\n  }\n\n  extraArgs.push(`--use-max-pods ${options.useMaxPods ?? true}`);\n\n  if (options.awsApiRetryAttempts) {\n    extraArgs.push(`--aws-api-retry-attempts ${options.awsApiRetryAttempts}`);\n  }\n\n  if (options.enableDockerBridge) {\n    extraArgs.push('--enable-docker-bridge true');\n  }\n\n  if (options.dockerConfigJson) {\n    extraArgs.push(`--docker-config-json '${options.dockerConfigJson}'`);\n  }\n\n  if (options.dnsClusterIp) {\n    extraArgs.push(`--dns-cluster-ip ${options.dnsClusterIp}`);\n  }\n\n  if (options.additionalArgs) {\n    extraArgs.push(options.additionalArgs);\n  }\n\n  const commandLineSuffix = extraArgs.join(' ');\n  const kubeletExtraArgsSuffix = options.kubeletExtraArgs || '';\n\n  // determine lifecycle label based on whether the ASG has a spot price.\n  const lifecycleLabel = autoScalingGroup.spotPrice ? LifecycleLabel.SPOT : LifecycleLabel.ON_DEMAND;\n  const withTaints = autoScalingGroup.spotPrice ? '--register-with-taints=spotInstance=true:PreferNoSchedule' : '';\n  const kubeletExtraArgs = `--node-labels lifecycle=${lifecycleLabel} ${withTaints} ${kubeletExtraArgsSuffix}`.trim();\n\n  return [\n    'set -o xtrace',\n    `/etc/eks/bootstrap.sh ${cluster.clusterName} --kubelet-extra-args \"${kubeletExtraArgs}\" ${commandLineSuffix}`.trim(),\n    `/opt/aws/bin/cfn-signal --exit-code $? --stack ${stack.stackName} --resource ${asgLogicalId} --region ${stack.region}`,\n  ];\n}\n\nexport function renderBottlerocketUserData(cluster: ICluster): string[] {\n  return [\n    '[settings.kubernetes]',\n    `api-server=\"${cluster.clusterEndpoint}\"`,\n    `cluster-certificate=\"${cluster.clusterCertificateAuthorityData}\"`,\n    `cluster-name=\"${cluster.clusterName}\"`,\n  ];\n}\n\n/**\n * The lifecycle label for node selector\n */\nexport enum LifecycleLabel {\n  /**\n   * on-demand instances\n   */\n  ON_DEMAND = 'OnDemand',\n  /**\n   * spot instances\n   */\n  SPOT = 'Ec2Spot'\n}\n"],
  "mappings": "uKACA,KAAA,QAAA,QAAA,cAIA,mCAA0C,QAAmB,iBAAgD,QAA4B,GAAE,QAEzI,KAAM,OAAQ,OAAA,MAAM,GAAG,kBAIjB,aAAe,AADT,iBAAiB,KAAK,aACT,UAEnB,UAAY,GAAI,OAEtB,GAAI,CACF,KAAM,iBAAkB,QAAQ,gBAC1B,gCACJ,QAAQ,gCACV,UAAU,KAAK,yBAAyB,oBACxC,UAAU,KAAK,qBAAqB,yCACpC,EAUF,UAAU,KAAK,kBAAkB,IAAA,QAAQ,cAAU,MAAA,KAAA,OAAA,GAAI,MAEnD,QAAQ,qBACV,UAAU,KAAK,4BAA4B,QAAQ,uBAGjD,QAAQ,oBACV,UAAU,KAAK,+BAGb,QAAQ,kBACV,UAAU,KAAK,yBAAyB,QAAQ,qBAG9C,QAAQ,cACV,UAAU,KAAK,oBAAoB,QAAQ,gBAGzC,QAAQ,gBACV,UAAU,KAAK,QAAQ,gBAGzB,KAAM,mBAAoB,UAAU,KAAK,KACnC,uBAAyB,QAAQ,kBAAoB,GAGrD,eAAiB,iBAAiB,UAAY,eAAe,KAAO,eAAe,UACnF,WAAa,iBAAiB,UAAY,4DAA8D,GACxG,iBAAmB,2BAA2B,kBAAkB,cAAc,yBAAyB,OAE7G,MAAO,CACL,gBACA,yBAAyB,QAAQ,qCAAqC,qBAAqB,oBAAoB,OAC/G,kDAAkD,MAAM,wBAAwB,yBAAyB,MAAM,UA3DnH,QAAA,0BAAA,0BA+DA,oCAA2C,QAAiB,CAC1D,MAAO,CACL,wBACA,eAAe,QAAQ,mBACvB,wBAAwB,QAAQ,mCAChC,iBAAiB,QAAQ,gBAL7B,QAAA,2BAAA,2BAYA,GAAY,gBAAZ,AAAA,UAAY,gBAAc,CAIxB,gBAAA,UAAA,WAIA,gBAAA,KAAA,YARU,eAAA,QAAA,gBAAA,SAAA,eAAc",
  "names": []
}
