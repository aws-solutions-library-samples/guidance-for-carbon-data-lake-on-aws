"use strict";var _a;Object.defineProperty(exports,"__esModule",{value:!0}),exports.StepScalingPolicy=void 0;const jsiiDeprecationWarnings=require("../../.warnings.jsii.js"),JSII_RTTI_SYMBOL_1=Symbol.for("jsii.rtti"),aws_autoscaling_common_1=require("../../aws-autoscaling-common"),cloudwatch=require("../../aws-cloudwatch"),constructs_1=require("constructs"),step_scaling_action_1=require("./step-scaling-action");class StepScalingPolicy extends constructs_1.Construct{constructor(scope,id,props){var _b,_c,_d,_e;super(scope,id);if(jsiiDeprecationWarnings.aws_cdk_lib_aws_applicationautoscaling_StepScalingPolicyProps(props),props.scalingSteps.length<2)throw new Error("You must supply at least 2 intervals for autoscaling");if(props.datapointsToAlarm!==void 0&&props.datapointsToAlarm<1)throw new RangeError(`datapointsToAlarm cannot be less than 1, got: ${props.datapointsToAlarm}`);const adjustmentType=props.adjustmentType||step_scaling_action_1.AdjustmentType.CHANGE_IN_CAPACITY,changesAreAbsolute=adjustmentType===step_scaling_action_1.AdjustmentType.EXACT_CAPACITY,intervals=aws_autoscaling_common_1.normalizeIntervals(props.scalingSteps,changesAreAbsolute),alarms=aws_autoscaling_common_1.findAlarmThresholds(intervals);if(alarms.lowerAlarmIntervalIndex!==void 0){const threshold=intervals[alarms.lowerAlarmIntervalIndex].upper;this.lowerAction=new step_scaling_action_1.StepScalingAction(this,"LowerPolicy",{adjustmentType,cooldown:props.cooldown,metricAggregationType:(_b=props.metricAggregationType)!==null&&_b!==void 0?_b:aggregationTypeFromMetric(props.metric),minAdjustmentMagnitude:props.minAdjustmentMagnitude,scalingTarget:props.scalingTarget});for(let i=alarms.lowerAlarmIntervalIndex;i>=0;i--)this.lowerAction.addAdjustment({adjustment:intervals[i].change,lowerBound:i!==0?intervals[i].lower-threshold:void 0,upperBound:intervals[i].upper-threshold});this.lowerAlarm=new cloudwatch.Alarm(this,"LowerAlarm",{metric:props.metric,alarmDescription:"Lower threshold scaling alarm",comparisonOperator:cloudwatch.ComparisonOperator.LESS_THAN_OR_EQUAL_TO_THRESHOLD,evaluationPeriods:(_c=props.evaluationPeriods)!==null&&_c!==void 0?_c:1,datapointsToAlarm:props.datapointsToAlarm,threshold}),this.lowerAlarm.addAlarmAction(new StepScalingAlarmAction(this.lowerAction))}if(alarms.upperAlarmIntervalIndex!==void 0){const threshold=intervals[alarms.upperAlarmIntervalIndex].lower;this.upperAction=new step_scaling_action_1.StepScalingAction(this,"UpperPolicy",{adjustmentType,cooldown:props.cooldown,metricAggregationType:(_d=props.metricAggregationType)!==null&&_d!==void 0?_d:aggregationTypeFromMetric(props.metric),minAdjustmentMagnitude:props.minAdjustmentMagnitude,scalingTarget:props.scalingTarget});for(let i=alarms.upperAlarmIntervalIndex;i<intervals.length;i++)this.upperAction.addAdjustment({adjustment:intervals[i].change,lowerBound:intervals[i].lower-threshold,upperBound:i!==intervals.length-1?intervals[i].upper-threshold:void 0});this.upperAlarm=new cloudwatch.Alarm(this,"UpperAlarm",{metric:props.metric,alarmDescription:"Upper threshold scaling alarm",comparisonOperator:cloudwatch.ComparisonOperator.GREATER_THAN_OR_EQUAL_TO_THRESHOLD,evaluationPeriods:(_e=props.evaluationPeriods)!==null&&_e!==void 0?_e:1,datapointsToAlarm:props.datapointsToAlarm,threshold}),this.upperAlarm.addAlarmAction(new StepScalingAlarmAction(this.upperAction))}}}exports.StepScalingPolicy=StepScalingPolicy,_a=JSII_RTTI_SYMBOL_1,StepScalingPolicy[_a]={fqn:"aws-cdk-lib.aws_applicationautoscaling.StepScalingPolicy",version:"2.15.0"};function aggregationTypeFromMetric(metric){var _b;const statistic=(_b=metric.toMetricConfig().metricStat)===null||_b===void 0?void 0:_b.statistic;if(statistic!=null)switch(statistic){case"Average":return step_scaling_action_1.MetricAggregationType.AVERAGE;case"Minimum":return step_scaling_action_1.MetricAggregationType.MINIMUM;case"Maximum":return step_scaling_action_1.MetricAggregationType.MAXIMUM;default:return step_scaling_action_1.MetricAggregationType.AVERAGE}}class StepScalingAlarmAction{constructor(stepScalingAction){this.stepScalingAction=stepScalingAction}bind(_scope,_alarm){return{alarmActionArn:this.stepScalingAction.scalingPolicyArn}}}
//# sourceMappingURL=step-scaling-policy.js.map
