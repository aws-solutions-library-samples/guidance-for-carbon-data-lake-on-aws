{
  "version": 3,
  "sources": ["origin.ts"],
  "sourcesContent": ["import { Duration, Token } from '../../core';\nimport { CfnDistribution } from './cloudfront.generated';\n\n// keep this import separate from other imports to reduce chance for merge conflicts with v2-main\n// eslint-disable-next-line no-duplicate-imports, import/order\nimport { Construct } from 'constructs';\n\n/**\n * The failover configuration used for Origin Groups,\n * returned in {@link OriginBindConfig.failoverConfig}.\n */\nexport interface OriginFailoverConfig {\n  /** The origin to use as the fallback origin. */\n  readonly failoverOrigin: IOrigin;\n\n  /**\n   * The HTTP status codes of the response that trigger querying the failover Origin.\n   *\n   * @default - 500, 502, 503 and 504\n   */\n  readonly statusCodes?: number[];\n}\n\n/** The struct returned from {@link IOrigin.bind}. */\nexport interface OriginBindConfig {\n  /**\n   * The CloudFormation OriginProperty configuration for this Origin.\n   *\n   * @default - nothing is returned\n   */\n  readonly originProperty?: CfnDistribution.OriginProperty;\n\n  /**\n   * The failover configuration for this Origin.\n   *\n   * @default - nothing is returned\n   */\n  readonly failoverConfig?: OriginFailoverConfig;\n}\n\n/**\n * Represents the concept of a CloudFront Origin.\n * You provide one or more origins when creating a Distribution.\n */\nexport interface IOrigin {\n  /**\n   * The method called when a given Origin is added\n   * (for the first time) to a Distribution.\n   */\n  bind(scope: Construct, options: OriginBindOptions): OriginBindConfig;\n}\n\n/**\n * Properties to define an Origin.\n */\nexport interface OriginProps {\n  /**\n   * An optional path that CloudFront appends to the origin domain name when CloudFront requests content from the origin.\n   * Must begin, but not end, with '/' (e.g., '/production/images').\n   *\n   * @default '/'\n   */\n  readonly originPath?: string;\n\n  /**\n   * The number of seconds that CloudFront waits when trying to establish a connection to the origin.\n   * Valid values are 1-10 seconds, inclusive.\n   *\n   * @default Duration.seconds(10)\n   */\n  readonly connectionTimeout?: Duration;\n\n  /**\n   * The number of times that CloudFront attempts to connect to the origin; valid values are 1, 2, or 3 attempts.\n   *\n   * @default 3\n   */\n  readonly connectionAttempts?: number;\n\n  /**\n   * A list of HTTP header names and values that CloudFront adds to requests it sends to the origin.\n   *\n   * @default {}\n   */\n  readonly customHeaders?: Record<string, string>;\n\n  /**\n   * When you enable Origin Shield in the AWS Region that has the lowest latency to your origin, you can get better network performance\n   *\n   * @see https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/origin-shield.html\n   *\n   * @default - origin shield not enabled\n   */\n  readonly originShieldRegion?: string;\n}\n\n/**\n * Options passed to Origin.bind().\n */\nexport interface OriginBindOptions {\n  /**\n   * The identifier of this Origin,\n   * as assigned by the Distribution this Origin has been used added to.\n   */\n  readonly originId: string;\n}\n\n/**\n * Represents a distribution origin, that describes the Amazon S3 bucket, HTTP server (for example, a web server),\n * Amazon MediaStore, or other server from which CloudFront gets your files.\n */\nexport abstract class OriginBase implements IOrigin {\n  private readonly domainName: string;\n  private readonly originPath?: string;\n  private readonly connectionTimeout?: Duration;\n  private readonly connectionAttempts?: number;\n  private readonly customHeaders?: Record<string, string>;\n  private readonly originShieldRegion?: string\n\n  protected constructor(domainName: string, props: OriginProps = {}) {\n    validateIntInRangeOrUndefined('connectionTimeout', 1, 10, props.connectionTimeout?.toSeconds());\n    validateIntInRangeOrUndefined('connectionAttempts', 1, 3, props.connectionAttempts, false);\n    validateCustomHeaders(props.customHeaders);\n\n    this.domainName = domainName;\n    this.originPath = this.validateOriginPath(props.originPath);\n    this.connectionTimeout = props.connectionTimeout;\n    this.connectionAttempts = props.connectionAttempts;\n    this.customHeaders = props.customHeaders;\n    this.originShieldRegion = props.originShieldRegion;\n  }\n\n  /**\n   * Binds the origin to the associated Distribution. Can be used to grant permissions, create dependent resources, etc.\n   */\n  public bind(_scope: Construct, options: OriginBindOptions): OriginBindConfig {\n    const s3OriginConfig = this.renderS3OriginConfig();\n    const customOriginConfig = this.renderCustomOriginConfig();\n\n    if (!s3OriginConfig && !customOriginConfig) {\n      throw new Error('Subclass must override and provide either s3OriginConfig or customOriginConfig');\n    }\n\n    return {\n      originProperty: {\n        domainName: this.domainName,\n        id: options.originId,\n        originPath: this.originPath,\n        connectionAttempts: this.connectionAttempts,\n        connectionTimeout: this.connectionTimeout?.toSeconds(),\n        originCustomHeaders: this.renderCustomHeaders(),\n        s3OriginConfig,\n        customOriginConfig,\n        originShield: this.renderOriginShield(this.originShieldRegion),\n      },\n    };\n  }\n\n  // Overridden by sub-classes to provide S3 origin config.\n  protected renderS3OriginConfig(): CfnDistribution.S3OriginConfigProperty | undefined {\n    return undefined;\n  }\n\n  // Overridden by sub-classes to provide custom origin config.\n  protected renderCustomOriginConfig(): CfnDistribution.CustomOriginConfigProperty | undefined {\n    return undefined;\n  }\n\n  private renderCustomHeaders(): CfnDistribution.OriginCustomHeaderProperty[] | undefined {\n    if (!this.customHeaders || Object.entries(this.customHeaders).length === 0) { return undefined; }\n    return Object.entries(this.customHeaders).map(([headerName, headerValue]) => {\n      return { headerName, headerValue };\n    });\n  }\n\n  /**\n   * If the path is defined, it must start with a '/' and not end with a '/'.\n   * This method takes in the originPath, and returns it back (if undefined) or adds/removes the '/' as appropriate.\n   */\n  private validateOriginPath(originPath?: string): string | undefined {\n    if (Token.isUnresolved(originPath)) { return originPath; }\n    if (originPath === undefined) { return undefined; }\n    let path = originPath;\n    if (!path.startsWith('/')) { path = '/' + path; }\n    if (path.endsWith('/')) { path = path.substr(0, path.length - 1); }\n    return path;\n  }\n\n  /**\n   * Takes origin shield region and converts to CfnDistribution.OriginShieldProperty\n   */\n  private renderOriginShield(originShieldRegion?: string): CfnDistribution.OriginShieldProperty | undefined {\n    return originShieldRegion\n      ? { enabled: true, originShieldRegion }\n      : undefined;\n  }\n}\n\n/**\n * Throws an error if a value is defined and not an integer or not in a range.\n */\nfunction validateIntInRangeOrUndefined(name: string, min: number, max: number, value?: number, isDuration: boolean = true) {\n  if (value === undefined) { return; }\n  if (!Number.isInteger(value) || value < min || value > max) {\n    const seconds = isDuration ? ' seconds' : '';\n    throw new Error(`${name}: Must be an int between ${min} and ${max}${seconds} (inclusive); received ${value}.`);\n  }\n}\n\n/**\n * Throws an error if custom header assignment is prohibited by CloudFront.\n * @link: https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/add-origin-custom-headers.html#add-origin-custom-headers-denylist\n */\nfunction validateCustomHeaders(customHeaders?: Record<string, string>) {\n  if (!customHeaders || Object.entries(customHeaders).length === 0) { return; }\n  const customHeaderKeys = Object.keys(customHeaders);\n  const prohibitedHeaderKeys = [\n    'Cache-Control', 'Connection', 'Content-Length', 'Cookie', 'Host', 'If-Match', 'If-Modified-Since', 'If-None-Match', 'If-Range', 'If-Unmodified-Since',\n    'Max-Forwards', 'Pragma', 'Proxy-Authorization', 'Proxy-Connection', 'Range', 'Request-Range', 'TE', 'Trailer', 'Transfer-Encoding', 'Upgrade', 'Via',\n    'X-Real-Ip',\n  ];\n  const prohibitedHeaderKeyPrefixes = [\n    'X-Amz-', 'X-Edge-',\n  ];\n\n  const prohibitedHeadersKeysMatches = customHeaderKeys.filter(customKey => {\n    return prohibitedHeaderKeys.map((prohibitedKey) => prohibitedKey.toLowerCase()).includes(customKey.toLowerCase());\n  });\n  const prohibitedHeaderPrefixMatches = customHeaderKeys.filter(customKey => {\n    return prohibitedHeaderKeyPrefixes.some(prohibitedKeyPrefix => customKey.toLowerCase().startsWith(prohibitedKeyPrefix.toLowerCase()));\n  });\n\n  if (prohibitedHeadersKeysMatches.length !== 0) {\n    throw new Error(`The following headers cannot be configured as custom origin headers: ${prohibitedHeadersKeysMatches.join(', ')}`);\n  }\n  if (prohibitedHeaderPrefixMatches.length !== 0) {\n    throw new Error(`The following headers cannot be used as prefixes for custom origin headers: ${prohibitedHeaderPrefixMatches.join(', ')}`);\n  }\n}"],
  "mappings": "iNAAA,OAAA,QAAA,cA+GA,gBAAgC,CAQ9B,YAAsB,WAAoB,MAAqB,GAAE,8EAC/D,8BAA8B,oBAAqB,EAAG,GAAE,IAAE,MAAM,qBAAiB,MAAA,KAAA,OAAA,OAAA,GAAE,aACnF,8BAA8B,qBAAsB,EAAG,EAAG,MAAM,mBAAoB,IACpF,sBAAsB,MAAM,eAE5B,KAAK,WAAa,WAClB,KAAK,WAAa,KAAK,mBAAmB,MAAM,YAChD,KAAK,kBAAoB,MAAM,kBAC/B,KAAK,mBAAqB,MAAM,mBAChC,KAAK,cAAgB,MAAM,cAC3B,KAAK,mBAAqB,MAAM,mBAM3B,KAAK,OAAmB,QAA0B,sFACvD,KAAM,gBAAiB,KAAK,uBACtB,mBAAqB,KAAK,2BAEhC,GAAI,CAAC,gBAAkB,CAAC,mBACtB,KAAM,IAAI,OAAM,kFAGlB,MAAO,CACL,eAAgB,CACd,WAAY,KAAK,WACjB,GAAI,QAAQ,SACZ,WAAY,KAAK,WACjB,mBAAoB,KAAK,mBACzB,kBAAiB,IAAE,KAAK,qBAAiB,MAAA,KAAA,OAAA,OAAA,GAAE,YAC3C,oBAAqB,KAAK,sBAC1B,eACA,mBACA,aAAc,KAAK,mBAAmB,KAAK,sBAMvC,sBAAoB,EAKpB,0BAAwB,EAI1B,qBAAmB,CACzB,GAAI,GAAC,KAAK,eAAiB,OAAO,QAAQ,KAAK,eAAe,SAAW,GACzE,MAAO,QAAO,QAAQ,KAAK,eAAe,IAAI,CAAC,CAAC,WAAY,eACnD,EAAE,WAAY,eAQjB,mBAAmB,WAAmB,CAC5C,GAAI,OAAA,MAAM,aAAa,YAAe,MAAO,YAC7C,GAAI,aAAe,OAAa,OAChC,GAAI,MAAO,WACX,MAAK,MAAK,WAAW,MAAQ,MAAO,IAAM,MACtC,KAAK,SAAS,MAAQ,MAAO,KAAK,OAAO,EAAG,KAAK,OAAS,IACvD,KAMD,mBAAmB,mBAA2B,CACpD,MAAO,oBACH,CAAE,QAAS,GAAM,oBACjB,QAnFR,QAAA,WAAA,+GA0FA,uCAAuC,KAAc,IAAa,IAAa,MAAgB,WAAsB,GAAI,CACvH,GAAI,QAAU,QACV,EAAC,OAAO,UAAU,QAAU,MAAQ,KAAO,MAAQ,KAAK,CAC1D,KAAM,SAAU,WAAa,WAAa,GAC1C,KAAM,IAAI,OAAM,GAAG,gCAAgC,WAAW,MAAM,iCAAiC,WAQzG,+BAA+B,cAAsC,CACnE,GAAI,CAAC,eAAiB,OAAO,QAAQ,eAAe,SAAW,EAAK,OACpE,KAAM,kBAAmB,OAAO,KAAK,eAC/B,qBAAuB,CAC3B,gBAAiB,aAAc,iBAAkB,SAAU,OAAQ,WAAY,oBAAqB,gBAAiB,WAAY,sBACjI,eAAgB,SAAU,sBAAuB,mBAAoB,QAAS,gBAAiB,KAAM,UAAW,oBAAqB,UAAW,MAChJ,aAEI,4BAA8B,CAClC,SAAU,WAGN,6BAA+B,iBAAiB,OAAO,WACpD,qBAAqB,IAAI,AAAC,eAAkB,cAAc,eAAe,SAAS,UAAU,gBAE/F,8BAAgC,iBAAiB,OAAO,WACrD,4BAA4B,KAAK,qBAAuB,UAAU,cAAc,WAAW,oBAAoB,iBAGxH,GAAI,6BAA6B,SAAW,EAC1C,KAAM,IAAI,OAAM,wEAAwE,6BAA6B,KAAK,SAE5H,GAAI,8BAA8B,SAAW,EAC3C,KAAM,IAAI,OAAM,+EAA+E,8BAA8B,KAAK",
  "names": []
}
