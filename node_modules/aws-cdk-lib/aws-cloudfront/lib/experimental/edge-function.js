"use strict";var _a;Object.defineProperty(exports,"__esModule",{value:!0}),exports.EdgeFunction=void 0;const jsiiDeprecationWarnings=require("../../../.warnings.jsii.js"),JSII_RTTI_SYMBOL_1=Symbol.for("jsii.rtti"),path=require("path"),iam=require("../../../aws-iam"),lambda=require("../../../aws-lambda"),ssm=require("../../../aws-ssm"),core_1=require("../../../core");class EdgeFunction extends core_1.Resource{constructor(scope,id,props){super(scope,id);this.isBoundToVpc=!1,jsiiDeprecationWarnings.aws_cdk_lib_aws_cloudfront_experimental_EdgeFunctionProps(props);const regionIsUsEast1=!core_1.Token.isUnresolved(this.stack.region)&&this.stack.region==="us-east-1",{edgeFunction,edgeArn}=regionIsUsEast1?this.createInRegionFunction(props):this.createCrossRegionFunction(id,props);this.edgeArn=edgeArn,this.functionArn=edgeArn,this._edgeFunction=edgeFunction,this.functionName=this._edgeFunction.functionName,this.grantPrincipal=this._edgeFunction.role,this.permissionsNode=this._edgeFunction.permissionsNode,this.version=lambda.extractQualifierFromArn(this.functionArn),this.architecture=this._edgeFunction.architecture,this.node.defaultChild=this._edgeFunction}get lambda(){return this._edgeFunction}get currentVersion(){return this}addAlias(aliasName,options={}){return jsiiDeprecationWarnings.aws_cdk_lib_aws_lambda_AliasOptions(options),new lambda.Alias(this._edgeFunction,`Alias${aliasName}`,{aliasName,version:this._edgeFunction.currentVersion,...options})}get connections(){throw new Error("Lambda@Edge does not support connections")}get latestVersion(){throw new Error("$LATEST function version cannot be used for Lambda@Edge")}addEventSourceMapping(id,options){return jsiiDeprecationWarnings.aws_cdk_lib_aws_lambda_EventSourceMappingOptions(options),this.lambda.addEventSourceMapping(id,options)}addPermission(id,permission){return jsiiDeprecationWarnings.aws_cdk_lib_aws_lambda_Permission(permission),this.lambda.addPermission(id,permission)}addToRolePolicy(statement){return jsiiDeprecationWarnings.aws_cdk_lib_aws_iam_PolicyStatement(statement),this.lambda.addToRolePolicy(statement)}grantInvoke(identity){return jsiiDeprecationWarnings.aws_cdk_lib_aws_iam_IGrantable(identity),this.lambda.grantInvoke(identity)}metric(metricName,props){return jsiiDeprecationWarnings.aws_cdk_lib_aws_cloudwatch_MetricOptions(props),this.lambda.metric(metricName,{...props,region:EdgeFunction.EDGE_REGION})}metricDuration(props){return jsiiDeprecationWarnings.aws_cdk_lib_aws_cloudwatch_MetricOptions(props),this.lambda.metricDuration({...props,region:EdgeFunction.EDGE_REGION})}metricErrors(props){return jsiiDeprecationWarnings.aws_cdk_lib_aws_cloudwatch_MetricOptions(props),this.lambda.metricErrors({...props,region:EdgeFunction.EDGE_REGION})}metricInvocations(props){return jsiiDeprecationWarnings.aws_cdk_lib_aws_cloudwatch_MetricOptions(props),this.lambda.metricInvocations({...props,region:EdgeFunction.EDGE_REGION})}metricThrottles(props){return jsiiDeprecationWarnings.aws_cdk_lib_aws_cloudwatch_MetricOptions(props),this.lambda.metricThrottles({...props,region:EdgeFunction.EDGE_REGION})}addEventSource(source){return jsiiDeprecationWarnings.aws_cdk_lib_aws_lambda_IEventSource(source),this.lambda.addEventSource(source)}configureAsyncInvoke(options){return jsiiDeprecationWarnings.aws_cdk_lib_aws_lambda_EventInvokeConfigOptions(options),this.lambda.configureAsyncInvoke(options)}createInRegionFunction(props){const edgeFunction=new lambda.Function(this,"Fn",props);return addEdgeLambdaToRoleTrustStatement(edgeFunction.role),{edgeFunction,edgeArn:edgeFunction.currentVersion.edgeArn}}createCrossRegionFunction(id,props){const parameterNamePrefix="cdk/EdgeFunctionArn";if(core_1.Token.isUnresolved(this.env.region))throw new Error("stacks which use EdgeFunctions must have an explicitly set region");const sanitizedPath=this.node.path.replace(/[^\/\w.-]/g,"_"),parameterName=`/${parameterNamePrefix}/${this.env.region}/${sanitizedPath}`,functionStack=this.edgeStack(props.stackId),edgeFunction=new lambda.Function(functionStack,id,props);addEdgeLambdaToRoleTrustStatement(edgeFunction.role);const version=edgeFunction.currentVersion;new ssm.StringParameter(edgeFunction,"Parameter",{parameterName,stringValue:version.edgeArn});const edgeArn=this.createCrossRegionArnReader(parameterNamePrefix,parameterName,version);return{edgeFunction,edgeArn}}createCrossRegionArnReader(parameterNamePrefix,parameterName,version){const parameterArnPrefix=this.stack.formatArn({service:"ssm",region:EdgeFunction.EDGE_REGION,resource:"parameter",resourceName:parameterNamePrefix+"/*"}),resourceType="Custom::CrossRegionStringParameterReader",serviceToken=core_1.CustomResourceProvider.getOrCreate(this,resourceType,{codeDirectory:path.join(__dirname,"edge-function"),runtime:core_1.CustomResourceProviderRuntime.NODEJS_12_X,policyStatements:[{Effect:"Allow",Resource:parameterArnPrefix,Action:["ssm:GetParameter"]}]});return new core_1.CustomResource(this,"ArnReader",{resourceType,serviceToken,properties:{Region:EdgeFunction.EDGE_REGION,ParameterName:parameterName,RefreshToken:core_1.Lazy.uncachedString({produce:()=>{const cfn=version.node.defaultChild;return this.stack.resolve(cfn.logicalId)}})}}).getAttString("FunctionArn")}edgeStack(stackId){const stage=core_1.Stage.of(this);if(!stage)throw new Error("stacks which use EdgeFunctions must be part of a CDK app or stage");const edgeStackId=stackId!=null?stackId:`edge-lambda-stack-${this.stack.node.addr}`;let edgeStack=stage.node.tryFindChild(edgeStackId);return edgeStack||(edgeStack=new core_1.Stack(stage,edgeStackId,{env:{region:EdgeFunction.EDGE_REGION,account:core_1.Stack.of(this).account}})),this.stack.addDependency(edgeStack),edgeStack}}exports.EdgeFunction=EdgeFunction,_a=JSII_RTTI_SYMBOL_1,EdgeFunction[_a]={fqn:"aws-cdk-lib.aws_cloudfront.experimental.EdgeFunction",version:"2.15.0"},EdgeFunction.EDGE_REGION="us-east-1";function addEdgeLambdaToRoleTrustStatement(role){if(role instanceof iam.Role&&role.assumeRolePolicy){const statement=new iam.PolicyStatement,edgeLambdaServicePrincipal=new iam.ServicePrincipal("edgelambda.amazonaws.com");statement.addPrincipals(edgeLambdaServicePrincipal),statement.addActions(edgeLambdaServicePrincipal.assumeRoleAction),role.assumeRolePolicy.addStatements(statement)}}
//# sourceMappingURL=edge-function.js.map
