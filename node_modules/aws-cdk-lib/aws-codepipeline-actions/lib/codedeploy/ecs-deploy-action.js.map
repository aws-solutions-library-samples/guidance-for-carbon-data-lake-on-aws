{
  "version": 3,
  "sources": ["ecs-deploy-action.ts"],
  "sourcesContent": ["import * as codedeploy from '../../../aws-codedeploy';\nimport * as codepipeline from '../../../aws-codepipeline';\nimport * as iam from '../../../aws-iam';\nimport { Lazy } from '../../../core';\nimport { Action } from '../action';\n\n// keep this import separate from other imports to reduce chance for merge conflicts with v2-main\n// eslint-disable-next-line no-duplicate-imports, import/order\nimport { Construct } from 'constructs';\n\n/**\n * Configuration for replacing a placeholder string in the ECS task\n * definition template file with an image URI.\n */\nexport interface CodeDeployEcsContainerImageInput {\n  /**\n   * The artifact that contains an `imageDetails.json` file with the image URI.\n   *\n   * The artifact's `imageDetails.json` file must be a JSON file containing an\n   * `ImageURI` property.  For example:\n   * `{ \"ImageURI\": \"ACCOUNTID.dkr.ecr.us-west-2.amazonaws.com/dk-image-repo@sha256:example3\" }`\n   */\n  readonly input: codepipeline.Artifact;\n\n  /**\n   * The placeholder string in the ECS task definition template file that will\n   * be replaced with the image URI.\n   *\n   * The placeholder string must be surrounded by angle brackets in the template file.\n   * For example, if the task definition template file contains a placeholder like\n   * `\"image\": \"<PLACEHOLDER>\"`, then the `taskDefinitionPlaceholder` value should\n   * be `PLACEHOLDER`.\n   *\n   * @default IMAGE\n   */\n  readonly taskDefinitionPlaceholder?: string;\n}\n\n/**\n * Construction properties of the {@link CodeDeployEcsDeployAction CodeDeploy ECS deploy CodePipeline Action}.\n */\nexport interface CodeDeployEcsDeployActionProps extends codepipeline.CommonAwsActionProps {\n  /**\n   * The CodeDeploy ECS Deployment Group to deploy to.\n   */\n  readonly deploymentGroup: codedeploy.IEcsDeploymentGroup;\n\n  /**\n   * The artifact containing the ECS task definition template file.\n   * During deployment, the task definition template file contents\n   * will be registered with ECS.\n   *\n   * If you use this property, it's assumed the file is called 'taskdef.json'.\n   * If your task definition template uses a different filename, leave this property empty,\n   * and use the `taskDefinitionTemplateFile` property instead.\n   *\n   * @default - one of this property, or `taskDefinitionTemplateFile`, is required\n   */\n  readonly taskDefinitionTemplateInput?: codepipeline.Artifact;\n\n  /**\n   * The name of the ECS task definition template file.\n   * During deployment, the task definition template file contents\n   * will be registered with ECS.\n   *\n   * Use this property if you want to use a different name for this file than the default 'taskdef.json'.\n   * If you use this property, you don't need to specify the `taskDefinitionTemplateInput` property.\n   *\n   * @default - one of this property, or `taskDefinitionTemplateInput`, is required\n   */\n  readonly taskDefinitionTemplateFile?: codepipeline.ArtifactPath;\n\n  /**\n   * The artifact containing the CodeDeploy AppSpec file.\n   * During deployment, a new task definition will be registered\n   * with ECS, and the new task definition ID will be inserted into\n   * the CodeDeploy AppSpec file.  The AppSpec file contents will be\n   * provided to CodeDeploy for the deployment.\n   *\n   * If you use this property, it's assumed the file is called 'appspec.yaml'.\n   * If your AppSpec file uses a different filename, leave this property empty,\n   * and use the `appSpecTemplateFile` property instead.\n   *\n   * @default - one of this property, or `appSpecTemplateFile`, is required\n   */\n  readonly appSpecTemplateInput?: codepipeline.Artifact;\n\n  /**\n   * The name of the CodeDeploy AppSpec file.\n   * During deployment, a new task definition will be registered\n   * with ECS, and the new task definition ID will be inserted into\n   * the CodeDeploy AppSpec file.  The AppSpec file contents will be\n   * provided to CodeDeploy for the deployment.\n   *\n   * Use this property if you want to use a different name for this file than the default 'appspec.yaml'.\n   * If you use this property, you don't need to specify the `appSpecTemplateInput` property.\n   *\n   * @default - one of this property, or `appSpecTemplateInput`, is required\n   */\n  readonly appSpecTemplateFile?: codepipeline.ArtifactPath;\n\n  /**\n   * Configuration for dynamically updated images in the task definition.\n   *\n   * Provide pairs of an image details input artifact and a placeholder string\n   * that will be used to dynamically update the ECS task definition template\n   * file prior to deployment. A maximum of 4 images can be given.\n   */\n  readonly containerImageInputs?: CodeDeployEcsContainerImageInput[];\n}\n\nexport class CodeDeployEcsDeployAction extends Action {\n  private readonly actionProps: CodeDeployEcsDeployActionProps;\n\n  constructor(props: CodeDeployEcsDeployActionProps) {\n    const inputs: codepipeline.Artifact[] = [];\n    inputs.push(determineTaskDefinitionArtifact(props));\n    inputs.push(determineAppSpecArtifact(props));\n\n    if (props.containerImageInputs) {\n      if (props.containerImageInputs.length > 4) {\n        throw new Error(`Action cannot have more than 4 container image inputs, got: ${props.containerImageInputs.length}`);\n      }\n\n      for (const imageInput of props.containerImageInputs) {\n        inputs.push(imageInput.input);\n      }\n    }\n\n    super({\n      ...props,\n      resource: props.deploymentGroup,\n      category: codepipeline.ActionCategory.DEPLOY,\n      provider: 'CodeDeployToECS',\n      artifactBounds: { minInputs: 1, maxInputs: 5, minOutputs: 0, maxOutputs: 0 },\n      inputs,\n    });\n\n    this.actionProps = props;\n  }\n\n  protected bound(_scope: Construct, _stage: codepipeline.IStage, options: codepipeline.ActionBindOptions):\n  codepipeline.ActionConfig {\n    // permissions, based on:\n    // https://docs.aws.amazon.com/codedeploy/latest/userguide/auth-and-access-control-permissions-reference.html\n\n    options.role.addToPolicy(new iam.PolicyStatement({\n      resources: [this.actionProps.deploymentGroup.application.applicationArn],\n      actions: ['codedeploy:GetApplication', 'codedeploy:GetApplicationRevision', 'codedeploy:RegisterApplicationRevision'],\n    }));\n\n    options.role.addToPolicy(new iam.PolicyStatement({\n      resources: [this.actionProps.deploymentGroup.deploymentGroupArn],\n      actions: ['codedeploy:CreateDeployment', 'codedeploy:GetDeployment'],\n    }));\n\n    options.role.addToPolicy(new iam.PolicyStatement({\n      resources: [this.actionProps.deploymentGroup.deploymentConfig.deploymentConfigArn],\n      actions: ['codedeploy:GetDeploymentConfig'],\n    }));\n\n    // Allow action to register the task definition template file with ECS\n    options.role.addToPolicy(new iam.PolicyStatement({\n      resources: ['*'],\n      actions: ['ecs:RegisterTaskDefinition'],\n    }));\n\n    // Allow passing any roles specified in the task definition template file to ECS\n    options.role.addToPolicy(new iam.PolicyStatement({\n      actions: ['iam:PassRole'],\n      resources: ['*'],\n      conditions: {\n        StringEqualsIfExists: {\n          'iam:PassedToService': [\n            'ecs-tasks.amazonaws.com',\n          ],\n        },\n      },\n    }));\n\n    // the Action's Role needs to read from the Bucket to get artifacts\n    options.bucket.grantRead(options.role);\n\n    const taskDefinitionTemplateArtifact = determineTaskDefinitionArtifact(this.actionProps);\n    const appSpecTemplateArtifact = determineAppSpecArtifact(this.actionProps);\n    const actionConfig: codepipeline.ActionConfig = {\n      configuration: {\n        ApplicationName: this.actionProps.deploymentGroup.application.applicationName,\n        DeploymentGroupName: this.actionProps.deploymentGroup.deploymentGroupName,\n\n        TaskDefinitionTemplateArtifact: Lazy.string({ produce: () => taskDefinitionTemplateArtifact.artifactName }),\n        TaskDefinitionTemplatePath: this.actionProps.taskDefinitionTemplateFile\n          ? this.actionProps.taskDefinitionTemplateFile.fileName\n          : 'taskdef.json',\n\n        AppSpecTemplateArtifact: Lazy.string({ produce: () => appSpecTemplateArtifact.artifactName }),\n        AppSpecTemplatePath: this.actionProps.appSpecTemplateFile\n          ? this.actionProps.appSpecTemplateFile.fileName\n          : 'appspec.yaml',\n      },\n    };\n\n    if (this.actionProps.containerImageInputs) {\n      for (let i = 1; i <= this.actionProps.containerImageInputs.length; i++) {\n        const imageInput = this.actionProps.containerImageInputs[i - 1];\n        actionConfig.configuration[`Image${i}ArtifactName`] = Lazy.string({ produce: () => imageInput.input.artifactName });\n        actionConfig.configuration[`Image${i}ContainerName`] = imageInput.taskDefinitionPlaceholder\n          ? imageInput.taskDefinitionPlaceholder\n          : 'IMAGE';\n      }\n    }\n\n    return actionConfig;\n  }\n}\n\nfunction determineTaskDefinitionArtifact(props: CodeDeployEcsDeployActionProps): codepipeline.Artifact {\n  if (props.taskDefinitionTemplateFile && props.taskDefinitionTemplateInput) {\n    throw new Error(\"Exactly one of 'taskDefinitionTemplateInput' or 'taskDefinitionTemplateFile' can be provided in the ECS CodeDeploy Action\");\n  }\n  if (props.taskDefinitionTemplateFile) {\n    return props.taskDefinitionTemplateFile.artifact;\n  }\n  if (props.taskDefinitionTemplateInput) {\n    return props.taskDefinitionTemplateInput;\n  }\n  throw new Error(\"Specifying one of 'taskDefinitionTemplateInput' or 'taskDefinitionTemplateFile' is required for the ECS CodeDeploy Action\");\n}\n\nfunction determineAppSpecArtifact(props: CodeDeployEcsDeployActionProps): codepipeline.Artifact {\n  if (props.appSpecTemplateFile && props.appSpecTemplateInput) {\n    throw new Error(\"Exactly one of 'appSpecTemplateInput' or 'appSpecTemplateFile' can be provided in the ECS CodeDeploy Action\");\n  }\n  if (props.appSpecTemplateFile) {\n    return props.appSpecTemplateFile.artifact;\n  }\n  if (props.appSpecTemplateInput) {\n    return props.appSpecTemplateInput;\n  }\n  throw new Error(\"Specifying one of 'appSpecTemplateInput' or 'appSpecTemplateFile' is required for the ECS CodeDeploy Action\");\n}\n"],
  "mappings": "mOACA,aAAA,QAAA,6BACA,IAAA,QAAA,oBACA,OAAA,QAAA,iBACA,SAAA,QAAA,aA2GA,uCAA+C,UAAA,MAAM,CAGnD,YAAY,MAAqC,oGAC/C,KAAM,QAAkC,GAIxC,GAHA,OAAO,KAAK,gCAAgC,QAC5C,OAAO,KAAK,yBAAyB,QAEjC,MAAM,qBAAsB,CAC9B,GAAI,MAAM,qBAAqB,OAAS,EACtC,KAAM,IAAI,OAAM,+DAA+D,MAAM,qBAAqB,UAG5G,SAAW,cAAc,OAAM,qBAC7B,OAAO,KAAK,WAAW,OAI3B,MAAM,IACD,MACH,SAAU,MAAM,gBAChB,SAAU,aAAa,eAAe,OACtC,SAAU,kBACV,eAAgB,CAAE,UAAW,EAAG,UAAW,EAAG,WAAY,EAAG,WAAY,GACzE,SAGF,KAAK,YAAc,MAGX,MAAM,OAAmB,OAA6B,QAAuC,qJAKrG,QAAQ,KAAK,YAAY,GAAI,KAAI,gBAAgB,CAC/C,UAAW,CAAC,KAAK,YAAY,gBAAgB,YAAY,gBACzD,QAAS,CAAC,4BAA6B,oCAAqC,6CAG9E,QAAQ,KAAK,YAAY,GAAI,KAAI,gBAAgB,CAC/C,UAAW,CAAC,KAAK,YAAY,gBAAgB,oBAC7C,QAAS,CAAC,8BAA+B,+BAG3C,QAAQ,KAAK,YAAY,GAAI,KAAI,gBAAgB,CAC/C,UAAW,CAAC,KAAK,YAAY,gBAAgB,iBAAiB,qBAC9D,QAAS,CAAC,qCAIZ,QAAQ,KAAK,YAAY,GAAI,KAAI,gBAAgB,CAC/C,UAAW,CAAC,KACZ,QAAS,CAAC,iCAIZ,QAAQ,KAAK,YAAY,GAAI,KAAI,gBAAgB,CAC/C,QAAS,CAAC,gBACV,UAAW,CAAC,KACZ,WAAY,CACV,qBAAsB,CACpB,sBAAuB,CACrB,gCAOR,QAAQ,OAAO,UAAU,QAAQ,MAEjC,KAAM,gCAAiC,gCAAgC,KAAK,aACtE,wBAA0B,yBAAyB,KAAK,aACxD,aAA0C,CAC9C,cAAe,CACb,gBAAiB,KAAK,YAAY,gBAAgB,YAAY,gBAC9D,oBAAqB,KAAK,YAAY,gBAAgB,oBAEtD,+BAAgC,OAAA,KAAK,OAAO,CAAE,QAAS,IAAM,+BAA+B,eAC5F,2BAA4B,KAAK,YAAY,2BACzC,KAAK,YAAY,2BAA2B,SAC5C,eAEJ,wBAAyB,OAAA,KAAK,OAAO,CAAE,QAAS,IAAM,wBAAwB,eAC9E,oBAAqB,KAAK,YAAY,oBAClC,KAAK,YAAY,oBAAoB,SACrC,iBAIR,GAAI,KAAK,YAAY,qBACnB,OAAS,GAAI,EAAG,GAAK,KAAK,YAAY,qBAAqB,OAAQ,IAAK,CACtE,KAAM,YAAa,KAAK,YAAY,qBAAqB,EAAI,GAC7D,aAAa,cAAc,QAAQ,iBAAmB,OAAA,KAAK,OAAO,CAAE,QAAS,IAAM,WAAW,MAAM,eACpG,aAAa,cAAc,QAAQ,kBAAoB,WAAW,0BAC9D,WAAW,0BACX,QAIR,MAAO,eArGX,QAAA,0BAAA,sKAyGA,yCAAyC,MAAqC,CAC5E,GAAI,MAAM,4BAA8B,MAAM,4BAC5C,KAAM,IAAI,OAAM,6HAElB,GAAI,MAAM,2BACR,MAAO,OAAM,2BAA2B,SAE1C,GAAI,MAAM,4BACR,MAAO,OAAM,4BAEf,KAAM,IAAI,OAAM,6HAGlB,kCAAkC,MAAqC,CACrE,GAAI,MAAM,qBAAuB,MAAM,qBACrC,KAAM,IAAI,OAAM,+GAElB,GAAI,MAAM,oBACR,MAAO,OAAM,oBAAoB,SAEnC,GAAI,MAAM,qBACR,MAAO,OAAM,qBAEf,KAAM,IAAI,OAAM",
  "names": []
}
